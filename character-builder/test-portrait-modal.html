<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Portrait Modal</title>
  <style>
    :root {
      --terminal-bg: #1a1a1a;
      --terminal-fg: #00ff00;
      --terminal-accent: #00ffff;
      --terminal-dim: #666666;
      --font-mono: 'Courier New', monospace;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --font-size-large: 18px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--terminal-bg);
      color: var(--terminal-fg);
      font-family: var(--font-mono);
      padding: 40px;
      line-height: 1.6;
    }

    .test-container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      color: var(--terminal-accent);
      margin-bottom: var(--spacing-xl);
      text-align: center;
    }

    .settings-section {
      background: #0a0a0a;
      border: 1px solid var(--terminal-fg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
      border-radius: 4px;
    }

    .settings-section h2 {
      color: var(--terminal-accent);
      margin-bottom: var(--spacing-md);
      font-size: 16px;
    }

    .settings-input {
      width: 100%;
      background: var(--terminal-bg);
      border: 1px solid var(--terminal-fg);
      color: var(--terminal-fg);
      font-family: var(--font-mono);
      padding: var(--spacing-sm);
      border-radius: 4px;
      margin-bottom: var(--spacing-sm);
    }

    .settings-btn {
      background: var(--terminal-accent);
      color: var(--terminal-bg);
      border: none;
      padding: var(--spacing-sm) var(--spacing-lg);
      font-family: var(--font-mono);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .settings-btn:hover {
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.5);
    }

    .character-section {
      background: #0a0a0a;
      border: 1px solid var(--terminal-fg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
      border-radius: 4px;
    }

    .character-section h2 {
      color: var(--terminal-accent);
      margin-bottom: var(--spacing-md);
      font-size: 16px;
    }

    select {
      width: 100%;
      background: var(--terminal-bg);
      border: 1px solid var(--terminal-fg);
      color: var(--terminal-fg);
      font-family: var(--font-mono);
      padding: var(--spacing-sm);
      border-radius: 4px;
      margin-bottom: var(--spacing-md);
    }

    .portrait-section {
      background: #0a0a0a;
      border: 2px solid var(--terminal-accent);
      padding: var(--spacing-lg);
      border-radius: 4px;
    }

    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      gap: var(--spacing-md);
    }

    .sheet-header-title {
      color: var(--terminal-accent);
      font-size: 16px;
      flex-shrink: 0;
    }

    .sheet-header-action {
      flex-shrink: 0;
      margin-left: auto;
    }

    .generate-ai-btn {
      background: transparent;
      border: 1px solid var(--terminal-accent);
      color: var(--terminal-accent);
      padding: var(--spacing-sm) var(--spacing-md);
      font-family: var(--font-mono);
      font-size: 12px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .generate-ai-btn:hover {
      background: rgba(0, 255, 255, 0.1);
      box-shadow: 0 0 8px rgba(0, 255, 255, 0.3);
    }

    .generate-ai-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .generate-ai-btn.generating {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #character-portrait {
      font-family: var(--font-mono);
      font-size: 8px;
      line-height: 1;
      white-space: pre;
      color: var(--terminal-fg);
      overflow-x: auto;
      padding: var(--spacing-md);
      background: var(--terminal-bg);
      border: 1px solid var(--terminal-fg);
      border-radius: 4px;
      min-height: 400px;
    }

    /* Prompt Modal */
    .prompt-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .prompt-modal {
      background: var(--terminal-bg);
      border: 2px solid var(--terminal-accent);
      border-radius: 8px;
      padding: var(--spacing-xl);
      max-width: 700px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 255, 255, 0.3);
    }

    .prompt-modal-header {
      color: var(--terminal-accent);
      font-size: var(--font-size-large);
      margin-bottom: var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .prompt-modal-close {
      background: transparent;
      border: none;
      color: var(--terminal-fg);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .prompt-modal-close:hover {
      color: var(--terminal-accent);
      transform: scale(1.2);
    }

    .prompt-modal-instructions {
      color: var(--terminal-dim);
      font-size: 14px;
      margin-bottom: var(--spacing-md);
      line-height: 1.5;
    }

    .prompt-modal-textarea {
      width: 100%;
      min-height: 200px;
      background: #0a0a0a;
      border: 1px solid var(--terminal-fg);
      color: var(--terminal-fg);
      font-family: var(--font-mono);
      font-size: 14px;
      padding: var(--spacing-md);
      border-radius: 4px;
      resize: vertical;
      margin-bottom: var(--spacing-md);
    }

    .prompt-modal-textarea:focus {
      outline: none;
      border-color: var(--terminal-accent);
      box-shadow: 0 0 8px rgba(0, 255, 255, 0.3);
    }

    .prompt-modal-buttons {
      display: flex;
      gap: var(--spacing-md);
      justify-content: flex-end;
    }

    .prompt-modal-btn {
      background: transparent;
      border: 1px solid var(--terminal-fg);
      color: var(--terminal-fg);
      padding: var(--spacing-sm) var(--spacing-lg);
      font-family: var(--font-mono);
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .prompt-modal-btn:hover {
      background: rgba(0, 255, 0, 0.1);
      border-color: var(--terminal-accent);
      color: var(--terminal-accent);
    }

    .prompt-modal-btn.primary {
      background: var(--terminal-accent);
      color: var(--terminal-bg);
      border-color: var(--terminal-accent);
    }

    .prompt-modal-btn.primary:hover {
      background: var(--terminal-fg);
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.5);
    }

    .prompt-modal-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .info-box {
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid var(--terminal-accent);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üé® Portrait Modal Test Page</h1>

    <div class="info-box">
      <strong>Instructions:</strong><br>
      1. Enter your OpenAI API key below<br>
      2. Select a race and class<br>
      3. Click "Generate Custom AI Portrait" to test the modal<br>
      4. Check the browser console (F12) for debug logs
    </div>

    <div class="settings-section">
      <h2>‚öôÔ∏è API Settings</h2>
      <input 
        type="text" 
        id="api-key-input" 
        class="settings-input" 
        placeholder="Enter OpenAI API Key (sk-...)"
      >
      <button class="settings-btn" onclick="TestApp.saveAPIKey()">Save API Key</button>
      <div id="api-status" style="margin-top: 8px; color: var(--terminal-dim);"></div>
    </div>

    <div class="character-section">
      <h2>üë§ Character</h2>
      <label>Race:</label>
      <select id="race-select" onchange="TestApp.updateCharacter()">
        <option value="">Select Race</option>
        <option value="human">Human</option>
        <option value="elf">Elf</option>
        <option value="dwarf">Dwarf</option>
        <option value="halfling">Halfling</option>
        <option value="dragonborn">Dragonborn</option>
        <option value="tiefling">Tiefling</option>
        <option value="gnome">Gnome</option>
        <option value="half-elf">Half-Elf</option>
        <option value="half-orc">Half-Orc</option>
      </select>

      <label>Class:</label>
      <select id="class-select" onchange="TestApp.updateCharacter()">
        <option value="">Select Class</option>
        <option value="fighter">Fighter</option>
        <option value="wizard">Wizard</option>
        <option value="rogue">Rogue</option>
        <option value="paladin">Paladin</option>
        <option value="barbarian">Barbarian</option>
        <option value="warlock">Warlock</option>
        <option value="cleric">Cleric</option>
        <option value="druid">Druid</option>
        <option value="bard">Bard</option>
        <option value="monk">Monk</option>
        <option value="ranger">Ranger</option>
        <option value="sorcerer">Sorcerer</option>
      </select>

      <label>Alignment (optional):</label>
      <select id="alignment-select" onchange="TestApp.updateCharacter()">
        <option value="">Select Alignment</option>
        <option value="lawful-good">Lawful Good</option>
        <option value="neutral-good">Neutral Good</option>
        <option value="chaotic-good">Chaotic Good</option>
        <option value="lawful-neutral">Lawful Neutral</option>
        <option value="true-neutral">True Neutral</option>
        <option value="chaotic-neutral">Chaotic Neutral</option>
        <option value="lawful-evil">Lawful Evil</option>
        <option value="neutral-evil">Neutral Evil</option>
        <option value="chaotic-evil">Chaotic Evil</option>
      </select>
    </div>

    <div class="portrait-section">
      <div class="sheet-header">
        <div class="sheet-header-title">[ CHARACTER PORTRAIT ]</div>
        <div class="sheet-header-action">
          <button 
            class="generate-ai-btn" 
            id="generate-btn" 
            onclick="TestApp.generateCustomAIPortrait()"
            disabled
          >
            ‚ú® Generate Custom AI Portrait
          </button>
        </div>
      </div>
      <pre id="character-portrait">
Select a race and class above to enable portrait generation.
      </pre>
    </div>
  </div>

  <script>
    // Storage Service
    const StorageService = {
      getAPIKey() {
        return localStorage.getItem('openai_api_key');
      },
      setAPIKey(key) {
        localStorage.setItem('openai_api_key', key);
      }
    };

    // AI Service
    const AIService = {
      async generateImageFromPrompt(prompt) {
        const apiKey = StorageService.getAPIKey();
        
        if (!apiKey) {
          throw new Error('No API key set');
        }
        
        try {
          console.log('üé® Calling DALL-E API with prompt:', prompt);
          
          const response = await fetch('https://api.openai.com/v1/images/generations', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
            },
            body: JSON.stringify({
              model: 'dall-e-3',
              prompt: prompt,
              n: 1,
              size: '1024x1024',
              quality: 'standard',
            }),
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(`DALL-E API error: ${response.status} - ${error.error?.message || 'Unknown error'}`);
          }
          
          const data = await response.json();
          return data.data[0].url;
        } catch (error) {
          console.error('DALL-E image generation error:', error);
          throw error;
        }
      }
    };

    // Image to ASCII Service
    const ImageToAsciiService = {
      async convertToAscii(imageUrl, width = 160, height = 80) {
        try {
          console.log('üîÑ Converting image to ASCII...');
          
          // Load image
          const img = await this.loadImage(imageUrl);
          
          // Create canvas
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          
          // Draw image to canvas
          ctx.drawImage(img, 0, 0, width, height);
          
          // Get image data
          const imageData = ctx.getImageData(0, 0, width, height);
          
          // Convert to ASCII with Floyd-Steinberg dithering
          const asciiArt = this.imageDataToAsciiDithered(imageData, width, height);
          
          console.log('‚úÖ ASCII conversion complete');
          return asciiArt;
        } catch (error) {
          console.error('ASCII conversion error:', error);
          throw error;
        }
      },
      
      loadImage(url) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = url;
        });
      },
      
      imageDataToAsciiDithered(imageData, width, height) {
        const ASCII_CHARS = ' .:-=+*#%@';
        const data = imageData.data;
        
        // Create grayscale array
        const gray = new Float32Array(width * height);
        for (let i = 0; i < data.length; i += 4) {
          const idx = i / 4;
          gray[idx] = (data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114);
        }
        
        // Floyd-Steinberg dithering
        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            const idx = y * width + x;
            const oldPixel = gray[idx];
            const newPixel = Math.round(oldPixel / 255 * (ASCII_CHARS.length - 1)) * (255 / (ASCII_CHARS.length - 1));
            gray[idx] = newPixel;
            const error = oldPixel - newPixel;
            
            // Distribute error
            if (x + 1 < width) gray[idx + 1] += error * 7 / 16;
            if (y + 1 < height) {
              if (x > 0) gray[idx + width - 1] += error * 3 / 16;
              gray[idx + width] += error * 5 / 16;
              if (x + 1 < width) gray[idx + width + 1] += error * 1 / 16;
            }
          }
        }
        
        // Convert to ASCII
        let result = '';
        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            const idx = y * width + x;
            const charIdx = Math.floor(gray[idx] / 255 * (ASCII_CHARS.length - 1));
            result += ASCII_CHARS[Math.max(0, Math.min(ASCII_CHARS.length - 1, charIdx))];
          }
          result += '\n';
        }
        
        return result;
      }
    };

    // ASCII Art Service
    const AsciiArtService = {
      async generateCustomAIPortraitWithPrompt(customPrompt) {
        try {
          console.log('üé® Generating custom AI portrait with custom prompt...');
          console.log('Prompt:', customPrompt);
          
          // Step 1: Generate image with DALL-E using custom prompt
          const imageUrl = await AIService.generateImageFromPrompt(customPrompt);
          
          if (!imageUrl) {
            throw new Error('DALL-E generation failed');
          }
          
          console.log('‚úÖ DALL-E image generated:', imageUrl);
          
          // Step 2: Convert to ASCII with high resolution
          console.log('Converting to ASCII with Floyd-Steinberg dithering...');
          const asciiArt = await ImageToAsciiService.convertToAscii(imageUrl, 160, 80);
          
          if (!asciiArt) {
            throw new Error('ASCII conversion failed');
          }
          
          console.log('‚úÖ Custom ASCII art generated successfully');
          return asciiArt;
        } catch (error) {
          console.error('Custom AI portrait generation error:', error);
          throw error;
        }
      }
    };

    // Test App
    const TestApp = {
      character: {
        race: '',
        class: '',
        alignment: ''
      },
      
      saveAPIKey() {
        const input = document.getElementById('api-key-input');
        const key = input.value.trim();
        
        if (!key) {
          alert('Please enter an API key');
          return;
        }
        
        if (!key.startsWith('sk-')) {
          alert('API key should start with "sk-"');
          return;
        }
        
        StorageService.setAPIKey(key);
        document.getElementById('api-status').textContent = '‚úÖ API key saved';
        this.updateButtonState();
      },
      
      updateCharacter() {
        this.character.race = document.getElementById('race-select').value;
        this.character.class = document.getElementById('class-select').value;
        this.character.alignment = document.getElementById('alignment-select').value;
        
        console.log('Character updated:', this.character);
        this.updateButtonState();
      },
      
      updateButtonState() {
        const btn = document.getElementById('generate-btn');
        const hasAPIKey = !!StorageService.getAPIKey();
        const hasRaceAndClass = this.character.race && this.character.class;
        
        btn.disabled = !hasAPIKey || !hasRaceAndClass;
        
        if (!hasAPIKey) {
          btn.title = 'Please set API key first';
        } else if (!hasRaceAndClass) {
          btn.title = 'Please select race and class';
        } else {
          btn.title = 'Generate a unique AI portrait with DALL-E';
        }
      },
      
      buildPromptForCharacter(character) {
        const parts = [];
        
        // ASCII optimization instructions
        parts.push("Fantasy D&D character portrait");
        parts.push("Create a high-contrast, grayscale illustration on a pure black background");
        parts.push("Use bold, graphic shapes with thick outlines and minimal fine detail");
        parts.push("The image should have bright highlights and deep shadows to maximize tonal separation");
        parts.push("Center the subject in the frame and avoid background texture");
        parts.push("Style should be simple, iconic, and optimized for ASCII art conversion");
        
        // Character description
        if (character.race) {
          parts.push(character.race + " race");
        }
        
        if (character.class) {
          parts.push(character.class + " class");
        }
        
        if (character.alignment) {
          parts.push(character.alignment.replace('-', ' ') + " alignment");
        }
        
        // Ending style reinforcement
        parts.push("full body portrait centered composition");
        parts.push("bold linework high detail monochromatic");
        
        return parts.join(", ");
      },
      
      showPromptModal(character) {
        return new Promise((resolve, reject) => {
          const defaultPrompt = this.buildPromptForCharacter(character);
          console.log('üìù Generated default prompt:', defaultPrompt);
          
          const modalHTML = `
            <div class="prompt-modal-overlay" id="prompt-modal">
              <div class="prompt-modal">
                <div class="prompt-modal-header">
                  <span>‚ú® Customize AI Portrait Prompt</span>
                  <button class="prompt-modal-close" onclick="TestApp.closePromptModal(false)">√ó</button>
                </div>
                
                <div class="prompt-modal-instructions">
                  Edit the prompt below to customize your portrait. The prompt is optimized for ASCII art conversion with high contrast and clear features.
                </div>
                
                <textarea class="prompt-modal-textarea" id="custom-prompt">${defaultPrompt}</textarea>
                
                <div class="prompt-modal-buttons">
                  <button class="prompt-modal-btn" onclick="TestApp.closePromptModal(false)">Cancel</button>
                  <button class="prompt-modal-btn primary" onclick="TestApp.confirmPromptModal()">Generate Portrait</button>
                </div>
              </div>
            </div>
          `;
          
          document.body.insertAdjacentHTML('beforeend', modalHTML);
          console.log('‚úÖ Modal added to DOM');
          
          // Focus the textarea
          setTimeout(() => {
            const textarea = document.getElementById('custom-prompt');
            if (textarea) {
              console.log('‚úÖ Textarea found, focusing...');
              textarea.focus();
              textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            } else {
              console.error('‚ùå Textarea not found');
            }
          }, 100);
          
          // Store resolve/reject for later use
          this._promptModalResolve = resolve;
          this._promptModalReject = reject;
        });
      },
      
      closePromptModal(confirmed) {
        // Get the textarea value BEFORE removing the modal
        const textarea = document.getElementById('custom-prompt');
        const customPrompt = textarea ? textarea.value.trim() : null;
        console.log(`üîç Modal closing - confirmed: ${confirmed}, prompt: "${customPrompt}"`);
        
        const modal = document.getElementById('prompt-modal');
        if (modal) {
          modal.remove();
        }
        
        if (this._promptModalResolve) {
          if (confirmed) {
            this._promptModalResolve(customPrompt);
          } else {
            this._promptModalReject(new Error('User cancelled'));
          }
          this._promptModalResolve = null;
          this._promptModalReject = null;
        }
      },
      
      confirmPromptModal() {
        this.closePromptModal(true);
      },
      
      async generateCustomAIPortrait() {
        try {
          if (!this.character.race || !this.character.class) {
            alert('Please select both race and class before generating a custom AI portrait');
            return;
          }
          
          // Show prompt modal and wait for user input
          let customPrompt;
          try {
            customPrompt = await this.showPromptModal(this.character);
          } catch (error) {
            // User cancelled
            console.log('User cancelled prompt customization');
            return;
          }
          
          if (!customPrompt) {
            alert('Please enter a prompt for the portrait');
            return;
          }
          
          // Get the button and update UI
          const button = document.getElementById('generate-btn');
          const portraitEl = document.getElementById('character-portrait');
          
          if (button) {
            button.disabled = true;
            button.classList.add('generating');
            button.textContent = '‚è≥ Generating...';
          }
          
          if (portraitEl) {
            portraitEl.textContent = `
[ GENERATING CUSTOM AI PORTRAIT... ]

This may take 10-15 seconds...

        üé®
       /   \\
      /     \\
     /_______\\
            `;
          }
          
          // Generate custom portrait with custom prompt
          const customPortrait = await AsciiArtService.generateCustomAIPortraitWithPrompt(customPrompt);
          
          // Update portrait
          if (portraitEl) {
            portraitEl.textContent = customPortrait;
          }
          
          // Reset button
          if (button) {
            button.disabled = false;
            button.classList.remove('generating');
            button.textContent = '‚ú® Generate Another';
          }
          
          console.log('‚úÖ Custom AI portrait generated and displayed');
          
        } catch (error) {
          console.error('Failed to generate custom AI portrait:', error);
          
          const button = document.getElementById('generate-btn');
          if (button) {
            button.disabled = false;
            button.classList.remove('generating');
            button.textContent = '‚ú® Generate Custom AI Portrait';
          }
          
          alert('Failed to generate custom AI portrait: ' + error.message);
        }
      },
      
      init() {
        // Check if API key is already saved
        if (StorageService.getAPIKey()) {
          document.getElementById('api-status').textContent = '‚úÖ API key loaded from storage';
        }
        this.updateButtonState();
        console.log('‚úÖ Test app initialized');
      }
    };

    // Initialize when page loads
    window.addEventListener('DOMContentLoaded', () => {
      TestApp.init();
    });
  </script>
</body>
</html>

