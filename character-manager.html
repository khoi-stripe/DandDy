<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Character Manager</title>
    <link rel="stylesheet" href="terminal-theme.css">
    <link rel="stylesheet" href="character-manager.css">
</head>
<body>
    <div class="terminal-frame">
    
    <!-- Welcome Modal (uses the builder's splash art/layout) -->
    <div id="welcomeModal" class="modal">
        <div class="modal-content welcome-modal">
            <div class="modal-body">
                <div class="welcome-body">
                    <div class="splash-content">
        <div class="splash-art">
                                                                                                         

                                                                                                         

                                                                                                         

                                                              55                                                               

                                                              44                                                               

                                                             4554                                                              

                                                            455545                                                             

                                                       55  44 44 44  45                                                        

                                                        4445  54  5554       4                                                 

                                               45    4455554454444445544    444                                                

                                               54554555     444445    554455455                                                

                                   4       55 455454 545  554 445455  445 445555 55      4                                     

                                   55      455554     55 55   45   5  44     544445      54                                    

                                   5444454454  44  5455       44       4445  44  5554554445                                    

                                   5445555    454545                      455544    444544                                     

                             5      4544    554454                           444545   5445      55                             

                             55   554555  44445               44               54455  454444   455                             

                            4555454    455445              54544554              544 445  4554 455                             

                     5      454545454445554             5455  44  5454             4444544454555545                            

                      444  4444 545555 455            554     45     5444           455  4445544554  544                       

                       554 5544554  44554          545        54        554           5445  4445544544                         

                        54544544     555        4544    445444445445455   5544        454     5555454                          

                         455555      44      555555445554   45  45   455445544444      55      55454                           

                         45454   5   44     455554         44    45          54544     45  5    4544                           

                      45  455  554   44     454           44      45           555     44  454   44  444                       

                      545444455544   55     554          45        55         4444     54  55545 45 555                        

                       445544554     55     4444        45 54    55 45        5 4      44    444444444                         

                        5455454   4  44      5 54      45 4445 54445455      45 4      54 55   445444                          

                     54  45545  545  45      4 54     54  4 44 54  44 44     5  4      54  444  54444  54                      

                     5455 545 4544   45      5  44   55   545  55  45  55   54  4      55  54544 55  455                       

                      5555554454     44      5   4  44  455545 54454    44  5   4      44    544455 545                        

                       44444444   5  45      4   4444        4           5454   5      44  5   5444455                         

                         444545 4544 45      4 4454455444545544454455555544545  4      45 4445 555444                          

                      444 545 54444  44      4444  544                  545  5545      55   5444 54 544                        

                        45545  545   54       4455   545              445  44454       55   445  4444                          

         555554555455      545 55454  54 5        4445  544          444 5444         4 45  45455 545                           

         45444444454445545444  544454 44 5            5554444      4444544            5 544545454 45                            

           5444445455444544454       4 5554              54445   545454             445 44         4                            

           4444444     55544454     44454444                44444554                44455544554445554                           

           4444445       54444454  445 545455                  44                44   45444554444544444                         

           5444444        4544454     445445445   5445554     4454454544445555544      444445    5444444444444445   4444545     

           5545444         4444445     4444454     5544445     5444  55444445444454    444444      5444444 544544    5455       

           5444445         5444444     5454444      5444445    4544   554454 5454444   444454       544444  45444   4444        

           5445445         4454445    444444455     44444445    545   554444   544445  444545       444445   44444 4445         

           5544444         4444444    544 54445     444454455   544   454444    54444  444445       5444444   44454445          

           4444445         5444444   5544 444445    4445444444  444    54444    44444  544545       4444444   4444544           

           4454444         4444445   5444  44444    4445 554444 544    54444    544454 544454       5444445    544444           

           4544445         4444454  5544545554455   5445   44444444    44445    44444  544445       4454445    45444            

            544445        4444444   4445554554445   4444    4544444    44545    44445  544455       445444     44445            

           5444444       54445444  4445     544444  5444     545444    44444   454455  544444      444544      54444            

           5544444    5445444455   5444     544444  5445      44444    54444 5454444  5554454     4544445      54444            

           5454445444454444454    45454     4544455 44454      4544   5544454444445   44445545454444455       4444455           

         445555455455444445     45444554   544444444445445      44   55554545455    54454544445454444        544554454          

                              454        5                                                     454                              

                            4554454454   45   4  45545         4         54554 44   54   445444444544                           

                                    55444 44454 455  454      555      5545 454 44445 454455        5                           

                                       54554    4      454    544    555      45   454555                                       

                                          55454 45544       55554 44       4455 544554                                          

                                             5445444   5554  455454  55554 44454454                                            

                                                45544 5454444 5544 544445  45445                                               

                                                  45445    545 55 544    5455                                                  

                                                     4454    444444    544                                                    

                                                       4545555 455454445                                                       

                                                          4444 55 5445                                                         

                                                            55455454                                                           

                                                              445                                                               

        </div>
                    </div>
                    <div class="welcome-actions">
                        <button class="terminal-btn" id="welcomeLoginBtn">LOG IN</button>
                        <button class="terminal-btn" id="welcomeRegisterBtn">CREATE ACCOUNT</button>
                        <button class="terminal-btn terminal-btn-secondary" id="welcomeDemoBtn">DEMO MODE</button>
                        <div class="welcome-version">DandDy v2.0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content" id="main-content">

    <!-- Header -->
    <header class="terminal-header">
        <div class="header-content">
            <div class="terminal-title">[ DandDy v2.0 ]</div>
            <div class="header-actions">
                <span id="userInfoDisplay"></span>
                <button id="authBtn" class="terminal-btn terminal-btn-small">LOGIN</button>
                <button id="importBtn" class="terminal-btn terminal-btn-small">↓ IMPORT</button>
                <button id="newCharacterBtn" class="terminal-btn terminal-btn-small">+ NEW CHARACTER</button>
            </div>
        </div>
    </header>

    <!-- Split Layout -->
    <div class="split-layout">
        <!-- Left Panel: Character List -->
        <div class="left-panel" id="character-list-panel">
            <!-- Controls Section -->
            <div class="controls-section">
                <!-- Guest mode notice (shown only when not logged in) -->
                <div id="guestNotice" class="guest-notice is-hidden">
                    <span class="guest-notice-icon">⚠</span>
                    <span class="highlight">Log in or create an account to save your characters.</span>
                    <button class="modal-close guest-notice-close" onclick="dismissGuestNotice()">&times;</button>
                </div>
                <div class="search-bar">
                    <div class="search-input-wrapper">
                        <input type="text" id="searchInput" class="terminal-input" placeholder="⌕ Search characters...">
                        <button id="clearSearchBtn" class="search-clear-btn" type="button" aria-label="Clear search">✕</button>
                    </div>
                    <div class="search-actions">
                        <button
                            id="sortToggleBtn"
                            class="search-sort-btn"
                            type="button"
                            aria-haspopup="listbox"
                            aria-expanded="false"
                            aria-controls="sortDropdown"
                        >SORT</button>
                        <div id="sortDropdown" class="sort-dropdown" role="listbox" aria-label="Sort characters">
                            <button class="sort-option" data-sort-value="alphabetical" role="option">
                                Alphabetical
                            </button>
                            <button class="sort-option" data-sort-value="dateModified" role="option">
                                Date modified
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Character Grid -->
            <div id="characterGrid" class="character-grid">
                <!-- Character cards will be inserted here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state">
                <div class="character-card new-character-card" onclick="createNewCharacter()">
                    <div class="card-details">
                        <div class="card-name">+ New Character</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Character Sheet -->
        <div class="right-panel" id="character-sheet-panel">
            <div class="sheet-placeholder">
                <div class="placeholder-icon">⚔</div>
            </div>
            <div id="characterSheet" class="character-sheet is-hidden">
                <!-- Character sheet will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">↓ Import Character</h2>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="terminal-text">Upload a character JSON file:</p>
                <input type="file" id="importFile" accept=".json" class="file-input-hidden">
                <button class="terminal-btn" onclick="document.getElementById('importFile').click()">CHOOSE FILE</button>
                <span id="fileName" class="terminal-text-dim file-name-label"></span>
            </div>
            <div class="modal-footer">
                <button class="terminal-btn" onclick="closeImportModal()">CANCEL</button>
                <button class="terminal-btn terminal-btn-primary" onclick="importCharacter()">IMPORT</button>
            </div>
        </div>
    </div>

    <!-- Duplicate Resolution Modal -->
    <div id="duplicateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">⚠ Duplicate Character Detected</h2>
                <button class="modal-close" onclick="closeDuplicateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="terminal-text">A character named "<span id="duplicateCharName"></span>" already exists in your collection.</p>
                <p class="terminal-text modal-body-question">What would you like to do?</p>
            </div>
            <div class="modal-footer modal-footer-centered">
                <button class="terminal-btn" onclick="closeDuplicateModal()">CANCEL</button>
                <button class="terminal-btn terminal-btn-warning" onclick="resolveDuplicate('overwrite')">REPLACE EXISTING</button>
                <button class="terminal-btn terminal-btn-primary" onclick="resolveDuplicate('keep-both')">KEEP BOTH</button>
            </div>
        </div>
    </div>

    <!-- Edit Details Modal -->
    <div id="editDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">✎ Edit Character Details</h2>
                <button class="modal-close" onclick="closeEditDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="terminal-text">Adjust campaign-specific details. These edits affect this saved copy only.</p>

                <p class="terminal-text-small">Skill Proficiencies <span class="terminal-text-dim">(one per line)</span></p>
                <textarea id="editSkills" class="terminal-textarea terminal-input" placeholder="e.g. Perception&#10;Stealth&#10;Investigation"></textarea>

                <p class="terminal-text-small modal-section-label">Class Equipment / Gear <span class="terminal-text-dim">(one item per line)</span></p>
                <textarea id="editEquipment" class="terminal-textarea terminal-input" placeholder="e.g. Longsword&#10;Chain Mail&#10;Explorer&#39;s Pack"></textarea>

                <p class="terminal-text-small modal-section-label">Tool Proficiencies <span class="terminal-text-dim">(one per line)</span></p>
                <textarea id="editTools" class="terminal-textarea terminal-input" placeholder="e.g. Thieves&#39; Tools&#10;Disguise Kit"></textarea>

                <p class="terminal-text-small modal-section-label">Languages <span class="terminal-text-dim">(one per line)</span></p>
                <textarea id="editLanguages" class="terminal-textarea terminal-input" placeholder="e.g. Common&#10;Elvish"></textarea>

                <p class="terminal-text-small modal-section-label">Backstory</p>
                <textarea id="editBackstory" class="terminal-textarea terminal-input" placeholder="Write your character&#39;s backstory here..."></textarea>
            </div>
            <div class="modal-footer modal-footer-end">
                <button class="terminal-btn" onclick="closeEditDetailsModal()">CANCEL</button>
                <button class="terminal-btn terminal-btn-primary" onclick="saveEditDetails()">SAVE CHANGES</button>
            </div>
        </div>
    </div>

    </div><!-- /main-content -->
    
    </div><!-- /terminal-frame -->
    
    <!-- Auth Modal (Login/Register) -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="authModalTitle">[ LOGIN ]</h2>
                <button class="modal-close" onclick="closeAuthModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="loginForm">
                    <p class="terminal-text">Sign in to sync your characters to the cloud.</p>
                    <p class="terminal-text-small">Username:</p>
                    <input type="text" id="loginUsername" class="terminal-input" placeholder="Enter username">
                    <p class="terminal-text-small modal-section-label">Password:</p>
                    <input type="password" id="loginPassword" class="terminal-input" placeholder="Enter password">
                    <p class="terminal-text-small modal-section-label terminal-text-dim">
                        <button class="link-button" type="button" onclick="openPasswordResetFromLogin()">Forgot your password?</button>
                    </p>
                    <p class="terminal-text-small modal-section-label terminal-text-dim">
                        Don't have an account? <a href="#" onclick="showRegisterForm(); return false;" class="terminal-link">Register here</a>
                    </p>
                </div>
                <div id="registerForm" class="is-hidden">
                    <p class="terminal-text">Create an account to sync your characters across devices.</p>
                    <p class="terminal-text-small">Username:</p>
                    <input type="text" id="registerUsername" class="terminal-input" placeholder="Choose username">
                    <p class="terminal-text-small modal-section-label">Email:</p>
                    <input type="email" id="registerEmail" class="terminal-input" placeholder="Enter email">
                    <p class="terminal-text-small modal-section-label">Password:</p>
                    <input type="password" id="registerPassword" class="terminal-input" placeholder="Choose password">
                    <p class="terminal-text-small modal-section-label terminal-text-dim">
                        Already have an account? <a href="#" onclick="showLoginForm(); return false;" class="terminal-link">Login here</a>
                    </p>
                </div>
                <div id="authError" class="terminal-text-error is-hidden"></div>
            </div>
            <div class="modal-footer modal-footer-end">
                <button class="terminal-btn" onclick="closeAuthModal()">CANCEL</button>
                <button id="loginBtn" class="terminal-btn terminal-btn-primary" onclick="handleLogin()">LOGIN</button>
                <button id="registerBtn" class="terminal-btn terminal-btn-primary is-hidden" onclick="handleRegister()">REGISTER</button>
            </div>
        </div>
    </div>
    
    <!-- Password Reset Modal -->
    <div id="passwordResetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">[ RESET PASSWORD ]</h2>
                <button class="modal-close" onclick="closePasswordResetModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="passwordResetRequestSection">
                    <p class="terminal-text">
                        Enter the email associated with your account. If an account exists, a reset link will be sent.
                    </p>
                    <p class="terminal-text-small modal-section-label">Email:</p>
                    <input type="email" id="passwordResetEmail" class="terminal-input" placeholder="Enter email">
                </div>
                <div id="passwordResetConfirmSection" class="is-hidden">
                    <p class="terminal-text">
                        Check your email for a reset link or token, then paste the token below with your new password.
                    </p>
                    <p class="terminal-text-small modal-section-label">Reset token:</p>
                    <input type="text" id="passwordResetToken" class="terminal-input" placeholder="Paste reset token">
                    <p class="terminal-text-small modal-section-label">New password:</p>
                    <input type="password" id="passwordResetNewPassword" class="terminal-input" placeholder="Enter new password">
                </div>
                <div id="passwordResetMessage" class="terminal-text-small terminal-text-dim" style="margin-top: 8px;"></div>
            </div>
            <div class="modal-footer modal-footer-end">
                <button class="terminal-btn" onclick="closePasswordResetModal()">CANCEL</button>
                <button id="passwordResetRequestBtn" class="terminal-btn terminal-btn-primary" onclick="handlePasswordResetRequest()">SEND RESET LINK</button>
                <button id="passwordResetConfirmBtn" class="terminal-btn terminal-btn-primary is-hidden" onclick="handlePasswordResetConfirm()">SET NEW PASSWORD</button>
            </div>
        </div>
    </div>
    
    <!-- Migration Modal -->
    <div id="migrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">[ MIGRATE TO CLOUD ]</h2>
                <button class="modal-close" onclick="closeMigrationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="terminal-text">You have <strong id="migrationCount">0</strong> character(s) stored locally.</p>
                <p class="terminal-text">Would you like to migrate them to cloud storage? This will sync your characters across devices.</p>
                <p class="terminal-text-small terminal-text-dim">Note: A backup will be automatically downloaded before migration.</p>
                <div id="migrationStatus" class="terminal-text is-hidden"></div>
            </div>
            <div class="modal-footer modal-footer-centered">
                <button class="terminal-btn" onclick="closeMigrationModal()">SKIP</button>
                <button class="terminal-btn terminal-btn-primary" onclick="startMigration()">MIGRATE NOW</button>
            </div>
        </div>
    </div>
    
    <!-- Portrait Prompt Modal (hidden by default) -->
    <div id="portraitPromptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">★ Customize AI Portrait</h2>
                <button class="modal-close" onclick="closePortraitPromptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="terminal-text">Describe your character's appearance. AI will generate a portrait optimized for ASCII art.</p>
                <p class="terminal-text-small terminal-text-dim">Be descriptive! (e.g., "a stoic dwarf fighter with a braided beard, holding a glowing axe")</p>
                <textarea id="portraitPrompt" class="terminal-textarea terminal-input" rows="6" placeholder="Enter custom description..."></textarea>
            </div>
            <div class="modal-footer modal-footer-end">
                <button class="terminal-btn" onclick="closePortraitPromptModal()">CANCEL</button>
                <button class="terminal-btn terminal-btn-primary" onclick="confirmGeneratePortrait()">GENERATE PORTRAIT</button>
            </div>
        </div>
    </div>
    
    <script src="version.js"></script>
    <script src="character-builder/character-builder-config.js"></script>
    <script src="character-builder/character-builder-utils.js"></script>
    <script src="character-builder/character-builder-services.js"></script>
    <script src="shared-character-sheet.js"></script>
    <script src="character-manager-api.js"></script>
    <script src="character-manager.js"></script>
</body>
</html>

