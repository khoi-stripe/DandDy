<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DandDy - D&D Character Manager</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_URL = 'http://localhost:8000';

        // Simple HTTP client
        const api = {
            post: async (endpoint, data) => {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token && { 'Authorization': `Bearer ${token}` })
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error(await response.text());
                return response.json();
            },
            get: async (endpoint) => {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}${endpoint}`, {
                    headers: {
                        ...(token && { 'Authorization': `Bearer ${token}` })
                    }
                });
                if (!response.ok) throw new Error(await response.text());
                return response.json();
            },
            delete: async (endpoint) => {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: 'DELETE',
                    headers: {
                        ...(token && { 'Authorization': `Bearer ${token}` })
                    }
                });
                if (!response.ok) throw new Error(await response.text());
            }
        };

        // Auth Page Component
        function AuthPage({ onLogin }) {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [role, setRole] = useState('player');
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isLogin) {
                        const data = await api.post('/auth/login', { email, password });
                        localStorage.setItem('token', data.access_token);
                        onLogin();
                    } else {
                        await api.post('/auth/register', { email, username, password, role });
                        const data = await api.post('/auth/login', { email, password });
                        localStorage.setItem('token', data.access_token);
                        onLogin();
                    }
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white rounded-lg shadow-xl p-8">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-gray-900 mb-2">üõ°Ô∏è DandDy</h1>
                            <p className="text-gray-600">D&D 5e Character Manager</p>
                        </div>

                        <div className="flex mb-6 space-x-2">
                            <button
                                onClick={() => setIsLogin(true)}
                                className={`flex-1 py-2 rounded-lg font-medium ${isLogin ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}
                            >
                                Login
                            </button>
                            <button
                                onClick={() => setIsLogin(false)}
                                className={`flex-1 py-2 rounded-lg font-medium ${!isLogin ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}
                            >
                                Register
                            </button>
                        </div>

                        {error && (
                            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input
                                    type="email"
                                    required
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                />
                            </div>

                            {!isLogin && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                    <input
                                        type="text"
                                        required
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                    />
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input
                                    type="password"
                                    required
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                />
                            </div>

                            {!isLogin && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Role</label>
                                    <select
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        value={role}
                                        onChange={(e) => setRole(e.target.value)}
                                    >
                                        <option value="player">Player</option>
                                        <option value="dm">Dungeon Master</option>
                                    </select>
                                </div>
                            )}

                            <button
                                type="submit"
                                className="w-full bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700"
                            >
                                {isLogin ? 'Login' : 'Register'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Dashboard Component
        function Dashboard({ onLogout }) {
            const [characters, setCharacters] = useState([]);
            const [user, setUser] = useState(null);
            const [showCreate, setShowCreate] = useState(false);

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    const userData = await api.get('/auth/me');
                    setUser(userData);
                    const charactersData = await api.get('/characters/');
                    setCharacters(charactersData);
                } catch (err) {
                    console.error(err);
                }
            };

            const handleDelete = async (id, name) => {
                if (confirm(`Delete ${name}?`)) {
                    try {
                        await api.delete(`/characters/${id}`);
                        setCharacters(characters.filter(c => c.id !== id));
                    } catch (err) {
                        alert('Failed to delete character');
                    }
                }
            };

            if (showCreate) {
                return <CreateCharacter onBack={() => { setShowCreate(false); loadData(); }} />;
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <nav className="bg-white shadow-sm border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center space-x-3">
                                    <span className="text-2xl">üõ°Ô∏è</span>
                                    <h1 className="text-2xl font-bold text-gray-900">DandDy</h1>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <span className="text-sm text-gray-700">{user?.username}</span>
                                    <span className={`px-3 py-1 text-xs rounded-full ${user?.role === 'dm' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                        {user?.role === 'dm' ? 'DM' : 'Player'}
                                    </span>
                                    <button
                                        onClick={onLogout}
                                        className="px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg"
                                    >
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        <div className="flex justify-between items-center mb-8">
                            <div>
                                <h2 className="text-3xl font-bold text-gray-900">My Characters</h2>
                                <p className="text-gray-600 mt-1">Manage your D&D characters</p>
                            </div>
                            <button
                                onClick={() => setShowCreate(true)}
                                className="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700"
                            >
                                + New Character
                            </button>
                        </div>

                        {characters.length === 0 ? (
                            <div className="bg-white rounded-lg shadow-md p-12 text-center">
                                <div className="text-6xl mb-4">‚öîÔ∏è</div>
                                <h3 className="text-xl font-bold text-gray-900 mb-2">No Characters Yet</h3>
                                <p className="text-gray-600 mb-6">Create your first character to begin your adventure</p>
                                <button
                                    onClick={() => setShowCreate(true)}
                                    className="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700"
                                >
                                    Create Character
                                </button>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {characters.map(character => (
                                    <div key={character.id} className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 className="text-xl font-bold text-gray-900">{character.name}</h3>
                                                <p className="text-sm text-gray-600">{character.race} {character.character_class}</p>
                                            </div>
                                            <span className="px-3 py-1 bg-blue-100 text-blue-700 text-sm font-bold rounded-full">
                                                Lv {character.level}
                                            </span>
                                        </div>

                                        <div className="mb-4">
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="font-medium text-gray-700">HP</span>
                                                <span className={`font-bold ${
                                                    character.hit_points_current / character.hit_points_max > 0.5 ? 'text-green-600' :
                                                    character.hit_points_current / character.hit_points_max > 0.25 ? 'text-orange-600' : 'text-red-600'
                                                }`}>
                                                    {character.hit_points_current}/{character.hit_points_max}
                                                </span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-2">
                                                <div
                                                    className={`h-2 rounded-full ${
                                                        character.hit_points_current / character.hit_points_max > 0.5 ? 'bg-green-500' :
                                                        character.hit_points_current / character.hit_points_max > 0.25 ? 'bg-orange-500' : 'bg-red-500'
                                                    }`}
                                                    style={{ width: `${(character.hit_points_current / character.hit_points_max) * 100}%` }}
                                                />
                                            </div>
                                        </div>

                                        <div className="flex justify-between text-sm">
                                            <span>üõ°Ô∏è AC {character.armor_class}</span>
                                            <span>‚ö° Init {character.initiative >= 0 ? '+' : ''}{character.initiative}</span>
                                            <span>üí® {character.speed}ft</span>
                                        </div>

                                        <button
                                            onClick={() => handleDelete(character.id, character.name)}
                                            className="mt-4 w-full px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100"
                                        >
                                            Delete
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // Create Character Component
        function CreateCharacter({ onBack }) {
            const [name, setName] = useState('');
            const [race, setRace] = useState('Human');
            const [characterClass, setCharacterClass] = useState('Fighter');
            const [level, setLevel] = useState(1);
            const [str, setStr] = useState(10);
            const [dex, setDex] = useState(10);
            const [con, setCon] = useState(10);
            const [int, setInt] = useState(10);
            const [wis, setWis] = useState(10);
            const [cha, setCha] = useState(10);
            const [loading, setLoading] = useState(false);
            
            // ASCII art state
            const [asciiArt, setAsciiArt] = useState('');
            const [loadingArt, setLoadingArt] = useState(false);
            
            // Load ASCII art when race or class changes
            useEffect(() => {
                const loadArt = async () => {
                    setLoadingArt(true);
                    const raceLower = race.toLowerCase().replace(/ /g, '-');
                    const classLower = characterClass.toLowerCase();
                    
                    // Try race-class combo first
                    try {
                        const response = await fetch(`/generated_portraits/ascii/${raceLower}-${classLower}.txt`);
                        if (response.ok) {
                            setAsciiArt(await response.text());
                            setLoadingArt(false);
                            return;
                        }
                    } catch (e) {}
                    
                    // Fallback to race only
                    try {
                        const response = await fetch(`/generated_portraits/ascii/${raceLower}.txt`);
                        if (response.ok) {
                            setAsciiArt(await response.text());
                        } else {
                            setAsciiArt('No portrait available');
                        }
                    } catch (e) {
                        setAsciiArt('Error loading portrait');
                    }
                    setLoadingArt(false);
                };
                loadArt();
            }, [race, characterClass]);

            const races = ['Dwarf', 'Elf', 'Halfling', 'Human', 'Dragonborn', 'Gnome', 'Half-Elf', 'Half-Orc', 'Tiefling'];
            const classes = ['Barbarian', 'Bard', 'Cleric', 'Druid', 'Fighter', 'Monk', 'Paladin', 'Ranger', 'Rogue', 'Sorcerer', 'Warlock', 'Wizard'];

            const rollStats = () => {
                const roll = () => {
                    const rolls = [1,2,3,4].map(() => Math.floor(Math.random() * 6) + 1);
                    rolls.sort();
                    return rolls[1] + rolls[2] + rolls[3];
                };
                setStr(roll());
                setDex(roll());
                setCon(roll());
                setInt(roll());
                setWis(roll());
                setCha(roll());
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                const conMod = Math.floor((con - 10) / 2);
                const dexMod = Math.floor((dex - 10) / 2);
                const maxHP = 10 + conMod;

                try {
                    await api.post('/characters/', {
                        name, race, character_class: characterClass, level,
                        strength: str, dexterity: dex, constitution: con,
                        intelligence: int, wisdom: wis, charisma: cha,
                        experience_points: 0, hit_points_max: maxHP,
                        hit_points_current: maxHP, hit_points_temp: 0,
                        armor_class: 10 + dexMod, initiative: dexMod, speed: 30,
                        death_save_successes: 0, death_save_failures: 0,
                        saving_throw_proficiencies: [], skill_proficiencies: [],
                        skill_expertises: [], racial_traits: [], class_features: [],
                        feats: [], inventory: [], spell_slots: {}, spell_slots_used: {},
                        spells_known: [], spells_prepared: [], conditions: [],
                        attacks: [], copper_pieces: 0, silver_pieces: 0,
                        electrum_pieces: 0, gold_pieces: 0, platinum_pieces: 0
                    });
                    onBack();
                } catch (err) {
                    alert('Failed to create character: ' + err.message);
                    setLoading(false);
                }
            };

            const mod = (score) => Math.floor((score - 10) / 2);

            return (
                <div className="min-h-screen bg-gray-50 py-8">
                    <div className="max-w-4xl mx-auto px-4">
                        <button onClick={onBack} className="mb-6 px-4 py-2 text-gray-600 hover:text-gray-900">
                            ‚Üê Back
                        </button>

                        <h1 className="text-3xl font-bold text-gray-900 mb-8">Create New Character</h1>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h2 className="text-xl font-bold mb-4">Basic Information</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                                        <input type="text" required className="w-full px-4 py-2 border border-gray-300 rounded-lg" value={name} onChange={(e) => setName(e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Level</label>
                                        <input type="number" min="1" max="20" className="w-full px-4 py-2 border border-gray-300 rounded-lg" value={level} onChange={(e) => setLevel(parseInt(e.target.value))} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Race</label>
                                        <select className="w-full px-4 py-2 border border-gray-300 rounded-lg" value={race} onChange={(e) => setRace(e.target.value)}>
                                            {races.map(r => <option key={r} value={r}>{r}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Class</label>
                                        <select className="w-full px-4 py-2 border border-gray-300 rounded-lg" value={characterClass} onChange={(e) => setCharacterClass(e.target.value)}>
                                            {classes.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">Ability Scores</h2>
                                    <button type="button" onClick={rollStats} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                        Roll 4d6 (drop lowest)
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    {[
                                        { label: 'Strength', value: str, setValue: setStr },
                                        { label: 'Dexterity', value: dex, setValue: setDex },
                                        { label: 'Constitution', value: con, setValue: setCon },
                                        { label: 'Intelligence', value: int, setValue: setInt },
                                        { label: 'Wisdom', value: wis, setValue: setWis },
                                        { label: 'Charisma', value: cha, setValue: setCha }
                                    ].map(ability => (
                                        <div key={ability.label} className="bg-gray-50 p-4 rounded-lg">
                                            <label className="block text-sm font-medium text-gray-700 mb-2">{ability.label}</label>
                                            <input type="number" min="1" max="20" className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2" value={ability.value} onChange={(e) => ability.setValue(parseInt(e.target.value) || 10)} />
                                            <p className="text-center text-2xl font-bold text-blue-600">{mod(ability.value) >= 0 ? '+' : ''}{mod(ability.value)}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="flex justify-end space-x-4">
                                <button type="button" onClick={onBack} className="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                    Cancel
                                </button>
                                <button type="submit" disabled={loading} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    {loading ? 'Creating...' : 'Create Character'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);

            useEffect(() => {
                const token = localStorage.getItem('token');
                if (token) {
                    setIsAuthenticated(true);
                }
            }, []);

            const handleLogout = () => {
                localStorage.removeItem('token');
                setIsAuthenticated(false);
            };

            return isAuthenticated ? 
                <Dashboard onLogout={handleLogout} /> : 
                <AuthPage onLogin={() => setIsAuthenticated(true)} />;
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

